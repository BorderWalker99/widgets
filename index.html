<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ¡£æ–‡å­—æå–å™¨ - æ”¯æŒWordå’ŒPDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066ff;
            --primary-dark: #0052cc;
            --surface: #ffffff;
            --surface-raised: #f8f9fa;
            --border: #e1e4e8;
            --text-primary: #1a1a1a;
            --text-secondary: #6a737d;
            --success: #28a745;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: var(--surface);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 48px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-10%, -10%); }
        }

        .header h1 {
            font-size: 36px;
            font-weight: 900;
            color: white;
            margin-bottom: 12px;
            position: relative;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            font-weight: 400;
        }

        .content {
            padding: 48px 40px;
        }

        .upload-area {
            border: 3px dashed var(--border);
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            background: var(--surface-raised);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f0f6ff;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: #e6f0ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
            display: block;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 14px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .format-badges {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 16px;
        }

        .badge {
            background: white;
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
            font-family: 'Noto Sans SC', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 255, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .file-info {
            background: var(--surface-raised);
            padding: 20px;
            border-radius: 12px;
            margin: 24px 0;
            display: none;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-size {
            font-size: 14px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .file-type {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }

        .status {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
            font-size: 14px;
            font-weight: 500;
            animation: fadeIn 0.4s ease;
        }

        .status.show {
            display: block;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success);
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .preview {
            background: var(--surface-raised);
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            border: 1px solid var(--border);
        }

        .preview.show {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .preview h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .preview-content {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.3s ease;
        }

        .footer {
            padding: 24px 40px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            border-top: 1px solid var(--border);
            background: var(--surface-raised);
        }

        @media (max-width: 640px) {
            .container {
                border-radius: 16px;
            }
            
            .header {
                padding: 32px 24px;
            }
            
            .header h1 {
                font-size: 28px;
            }
            
            .content {
                padding: 32px 24px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“„ æ–‡æ¡£æ–‡å­—æå–å™¨</h1>
            <p>å¿«é€Ÿæå–Wordå’ŒPDFæ–‡æ¡£ä¸­çš„æ‰€æœ‰æ–‡å­—ï¼Œç”Ÿæˆçº¯æ–‡å­—ç‰ˆæœ¬</p>
        </div>

        <div class="content">
            <div class="upload-area" id="uploadArea">
                <span class="upload-icon">ğŸ“</span>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡æ¡£</div>
                <div class="upload-hint">æ”¯æŒå¤šç§æ ¼å¼</div>
                <div class="format-badges">
                    <span class="badge">.DOCX</span>
                    <span class="badge">.PDF</span>
                </div>
                <input type="file" id="fileInput" accept=".docx,.pdf">
            </div>

            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName">
                    <span id="fileIcon">ğŸ“„</span>
                    <span id="fileNameText"></span>
                    <span class="file-type" id="fileType"></span>
                </div>
                <div class="file-size" id="fileSize"></div>
            </div>

            <div class="status" id="status">
                <div id="statusText"></div>
                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="preview" id="preview">
                <h3>ğŸ“ æ–‡å­—é¢„è§ˆ</h3>
                <div class="preview-content" id="previewContent"></div>
            </div>

            <div class="actions">
                <button class="btn" id="extractBtn" style="display: none;">
                    <span>âœ¨</span>
                    <span>æå–æ–‡å­—</span>
                </button>
                <button class="btn" id="downloadDocBtn" style="display: none;">
                    <span>ğŸ“˜</span>
                    <span>ä¸‹è½½Wordæ–‡æ¡£</span>
                </button>
            </div>
        </div>

        <div class="footer">
            çº¯æµè§ˆå™¨è¿è¡Œ Â· æ•°æ®ä¸ä¸Šä¼ æœåŠ¡å™¨ Â· å®Œå…¨æœ¬åœ°å¤„ç† Â· æ”¯æŒWordå’ŒPDF
        </div>
    </div>

    <script>
        // é…ç½® PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let extractedText = '';
        let originalFileName = '';
        let currentFile = null;
        let fileType = '';

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileNameText');
        const fileSize = document.getElementById('fileSize');
        const fileTypeEl = document.getElementById('fileType');
        const fileIcon = document.getElementById('fileIcon');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const preview = document.getElementById('preview');
        const previewContent = document.getElementById('previewContent');
        const extractBtn = document.getElementById('extractBtn');
        const downloadDocBtn = document.getElementById('downloadDocBtn');

        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.docx') || file.name.endsWith('.pdf'))) {
                handleFile(file);
            } else {
                showStatus('è¯·ä¸Šä¼ .docxæˆ–.pdfæ ¼å¼çš„æ–‡æ¡£', 'error');
            }
        });

        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            currentFile = file;
            const extension = file.name.split('.').pop().toLowerCase();
            fileType = extension;
            originalFileName = file.name.replace(new RegExp(`\\.${extension}$`), '');
            
            // è®¾ç½®æ–‡ä»¶å›¾æ ‡å’Œç±»å‹æ ‡ç­¾
            if (extension === 'pdf') {
                fileIcon.textContent = 'ğŸ“•';
                fileTypeEl.textContent = 'PDF';
            } else {
                fileIcon.textContent = 'ğŸ“„';
                fileTypeEl.textContent = 'WORD';
            }
            
            fileInfo.classList.add('show');
            fileName.textContent = file.name;
            fileSize.textContent = `æ–‡ä»¶å¤§å°: ${(file.size / 1024).toFixed(2)} KB`;
            
            extractBtn.style.display = 'inline-flex';
            downloadDocBtn.style.display = 'none';
            preview.classList.remove('show');
            status.classList.remove('show');
            progressBar.style.display = 'none';
        }

        // ä»PDFæå–æ–‡å­—ï¼ˆæ™ºèƒ½è¯†åˆ«æ®µè½ï¼ŒåŒä¸€æ®µè½ä¸æ¢è¡Œï¼‰
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const totalPages = pdf.numPages;
            let fullText = '';

            for (let i = 1; i <= totalPages; i++) {
                // æ›´æ–°è¿›åº¦
                const progress = (i / totalPages) * 100;
                updateProgress(progress, `æ­£åœ¨å¤„ç†ç¬¬ ${i}/${totalPages} é¡µ...`);

                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                // æå–æ–‡å­—å¹¶æ™ºèƒ½è¯†åˆ«æ®µè½
                let pageText = '';
                let lastFontSize = null;
                let lastFontName = null;
                let lastY = null;
                let lastStr = '';
                
                textContent.items.forEach((item, index) => {
                    const str = item.str;
                    if (!str.trim()) return; // è·³è¿‡çº¯ç©ºæ ¼
                    
                    // è·å–å­—å·å’Œå­—ä½“ä¿¡æ¯
                    const fontSize = Math.abs(item.transform[3]);
                    const fontName = item.fontName || '';
                    const currentY = item.transform[5]; // Yåæ ‡
                    
                    // åˆ¤æ–­æ˜¯å¦éœ€è¦æ¢è¡Œï¼ˆæ–°æ®µè½ï¼‰
                    let shouldNewLine = false;
                    
                    // æ£€æŸ¥å½“å‰æ–‡æœ¬æ˜¯å¦æ˜¯åˆ—è¡¨é¡¹å¼€å¤´ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
                    const isListItem = checkListFormat(str.trim());
                    
                    // å¦‚æœæ˜¯åˆ—è¡¨é¡¹ä¸”ä¸æ˜¯ç¬¬ä¸€è¡Œï¼Œå¼ºåˆ¶æ¢è¡Œ
                    if (isListItem && pageText.trim()) {
                        shouldNewLine = true;
                    } else if (lastFontSize !== null && lastStr) {
                        const fontSizeDiff = Math.abs(fontSize - lastFontSize);
                        const yDiff = lastY !== null ? Math.abs(currentY - lastY) : 0;
                        
                        // åˆ¤æ–­ä¸Šä¸€å¥æ˜¯å¦ç»“æŸï¼ˆæ˜¯å¦æœ‰ç»“æŸæ ‡ç‚¹ï¼‰
                        const lastEnded = /[ã€‚ï¼ï¼Ÿ.!?;ï¼›]\s*$/.test(lastStr.trim());
                        
                        // æ¢è¡Œæ¡ä»¶ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
                        // 1. å­—å·å˜åŒ–è¶…è¿‡0.5ï¼ˆæ ‡é¢˜ã€æ­£æ–‡ç­‰åˆ‡æ¢ï¼‰
                        if (fontSizeDiff > 0.5) {
                            shouldNewLine = true;
                        }
                        // 2. å­—ä½“å˜åŒ–
                        else if (fontName !== lastFontName) {
                            shouldNewLine = true;
                        }
                        // 3. Yåæ ‡å˜åŒ–å¤§ï¼ˆè¶…è¿‡2å€è¡Œé«˜ï¼‰ä¸”ä¸Šä¸€å¥å·²ç»“æŸ
                        else if (yDiff > fontSize * 2 && lastEnded) {
                            shouldNewLine = true;
                        }
                    }
                    
                    if (shouldNewLine) {
                        pageText += '\n';
                    } else if (pageText && lastStr) {
                        // åŒä¸€æ®µè½å†…ï¼Œæ™ºèƒ½æ·»åŠ ç©ºæ ¼
                        const lastChar = lastStr.trim().slice(-1);
                        const firstChar = str.trim()[0];
                        
                        // åˆ¤æ–­æ˜¯å¦éœ€è¦ç©ºæ ¼
                        const lastIsLatin = /[a-zA-Z0-9]/.test(lastChar);
                        const firstIsLatin = /^[a-zA-Z0-9]/.test(firstChar);
                        
                        // åªåœ¨è‹±æ–‡å•è¯ä¹‹é—´æ·»åŠ ç©ºæ ¼ï¼Œä¸­æ–‡ä¸åŠ 
                        if (lastIsLatin && firstIsLatin && !lastStr.endsWith(' ') && !str.startsWith(' ')) {
                            pageText += ' ';
                        }
                    }
                    
                    pageText += str;
                    lastFontSize = fontSize;
                    lastFontName = fontName;
                    lastY = currentY;
                    lastStr = str;
                });
                
                fullText += pageText.trim();
                
                // æ¢é¡µæ—¶æ·»åŠ åŒæ¢è¡Œåˆ†éš”ï¼ˆé™¤äº†æœ€åä¸€é¡µï¼‰
                if (i < totalPages) {
                    fullText += '\n\n';
                }
            }

            return fullText.trim();
        }

        // ä»Wordæ–‡æ¡£æå–æ–‡å­—
        async function extractTextFromWord(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
            return result.value.trim();
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ—è¡¨æ ¼å¼å¼€å¤´
        function checkListFormat(str) {
            if (!str) return false;
            
            // å„ç§åˆ—è¡¨æ ¼å¼çš„æ­£åˆ™è¡¨è¾¾å¼ï¼ˆä¸åŒ…å«å­—æ¯åºå·ï¼‰
            const listPatterns = [
                // æ•°å­—åºå·ï¼š1. 2. 3. æˆ– 1ã€2ã€3ã€ æˆ– 1) 2) 3)
                /^\d+[\.\)ã€]\s*/,
                
                // ä¸­æ–‡åºå·ï¼šä¸€ã€äºŒã€ä¸‰ã€
                /^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+[ã€\.]\s*/,
                
                // åœ†åœˆæ•°å­—ï¼šâ‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©
                /^[â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©â‘ªâ‘«â‘¬â‘­â‘®â‘¯â‘°â‘±â‘²â‘³]/,
                
                // æ‹¬å·åºå·ï¼š(1) (2) (3) æˆ– ï¼ˆ1ï¼‰ ï¼ˆ2ï¼‰
                /^[ï¼ˆ\(]\d+[ï¼‰\)]\s*/,
                
                // é¡¹ç›®ç¬¦å·ï¼šâ€¢ Â· * -
                /^[â€¢Â·\*\-]\s+/,
            ];
            
            // æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•åˆ—è¡¨æ ¼å¼
            return listPatterns.some(pattern => pattern.test(str));
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, message) {
            progressBar.style.display = 'block';
            progressFill.style.width = percent + '%';
            statusText.textContent = message;
        }

        // æå–æ–‡å­—
        extractBtn.addEventListener('click', async () => {
            if (!currentFile) return;

            showStatus('æ­£åœ¨æå–æ–‡å­—...', 'processing');
            extractBtn.disabled = true;
            extractBtn.innerHTML = '<span class="spinner"></span><span>å¤„ç†ä¸­...</span>';
            progressBar.style.display = 'none';

            try {
                if (fileType === 'pdf') {
                    extractedText = await extractTextFromPDF(currentFile);
                } else if (fileType === 'docx') {
                    showStatus('æ­£åœ¨æå–æ–‡å­—...', 'processing');
                    extractedText = await extractTextFromWord(currentFile);
                }
                
                if (!extractedText) {
                    showStatus('æœªèƒ½æå–åˆ°æ–‡å­—å†…å®¹ï¼Œè¯·æ£€æŸ¥æ–‡æ¡£æ˜¯å¦åŒ…å«æ–‡å­—', 'error');
                    extractBtn.disabled = false;
                    extractBtn.innerHTML = '<span>âœ¨</span><span>æå–æ–‡å­—</span>';
                    progressBar.style.display = 'none';
                    return;
                }

                // æ˜¾ç¤ºé¢„è§ˆ
                preview.classList.add('show');
                const previewText = extractedText.length > 1000 
                    ? extractedText.substring(0, 1000) + '\n\n... (é¢„è§ˆå‰1000å­—ç¬¦)' 
                    : extractedText;
                previewContent.textContent = previewText;

                progressBar.style.display = 'none';
                showStatus(`âœ… æˆåŠŸæå– ${extractedText.length} ä¸ªå­—ç¬¦`, 'success');
                downloadDocBtn.style.display = 'inline-flex';
                extractBtn.disabled = false;
                extractBtn.innerHTML = '<span>âœ¨</span><span>é‡æ–°æå–</span>';

            } catch (error) {
                console.error(error);
                showStatus('æå–å¤±è´¥: ' + error.message, 'error');
                extractBtn.disabled = false;
                extractBtn.innerHTML = '<span>âœ¨</span><span>æå–æ–‡å­—</span>';
                progressBar.style.display = 'none';
            }
        });

        // ä¸‹è½½Wordæ–‡æ¡£ï¼ˆæ‰‹åŠ¨æ„å»ºæ ‡å‡†docxæ ¼å¼ï¼‰
        downloadDocBtn.addEventListener('click', async () => {
            if (!extractedText) return;

            downloadDocBtn.disabled = true;
            downloadDocBtn.innerHTML = '<span class="spinner"></span><span>ç”Ÿæˆä¸­...</span>';

            try {
                // åˆ›å»ºzipå¯¹è±¡
                const zip = new JSZip();
                
                // å¤„ç†æ®µè½å’Œåˆ†é¡µ
                let documentXml = '';
                const sections = extractedText.split('\n\n'); // æŒ‰åŒæ¢è¡Œåˆ†å‰²ï¼ˆåˆ†é¡µæ ‡è®°ï¼‰
                
                sections.forEach((section, sectionIndex) => {
                    if (!section.trim()) return;
                    
                    // æ¯ä¸ªsectionå†…çš„å•æ¢è¡Œæ˜¯æ®µè½
                    const paragraphs = section.split('\n').filter(p => p.trim());
                    
                    paragraphs.forEach(para => {
                        documentXml += `
                            <w:p>
                                <w:pPr>
                                    <w:spacing w:after="120" w:line="276" w:lineRule="auto"/>
                                    <w:jc w:val="both"/>
                                </w:pPr>
                                <w:r>
                                    <w:rPr>
                                        <w:rFonts w:ascii="å®‹ä½“" w:eastAsia="å®‹ä½“" w:hAnsi="å®‹ä½“"/>
                                        <w:sz w:val="24"/>
                                        <w:szCs w:val="24"/>
                                    </w:rPr>
                                    <w:t xml:space="preserve">${escapeXml(para)}</w:t>
                                </w:r>
                            </w:p>`;
                    });
                    
                    // åœ¨sectionsä¹‹é—´æ·»åŠ ç©ºè¡Œï¼ˆé™¤äº†æœ€åä¸€ä¸ªsectionï¼‰
                    if (sectionIndex < sections.length - 1) {
                        documentXml += `
                            <w:p>
                                <w:pPr>
                                    <w:spacing w:after="0" w:line="276" w:lineRule="auto"/>
                                </w:pPr>
                            </w:p>`;
                    }
                });
                
                // [Content_Types].xml
                zip.file('[Content_Types].xml', 
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
    <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
    <Default Extension="xml" ContentType="application/xml"/>
    <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
    <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
    <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
</Types>`);

                // _rels/.rels
                zip.folder('_rels').file('.rels',
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
    <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
    <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
</Relationships>`);

                // docProps/core.xml
                zip.folder('docProps').file('core.xml',
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <dc:title>çº¯æ–‡å­—æ–‡æ¡£</dc:title>
    <dc:creator>æ–‡æ¡£æå–å™¨</dc:creator>
    <cp:lastModifiedBy>æ–‡æ¡£æå–å™¨</cp:lastModifiedBy>
    <cp:revision>1</cp:revision>
    <dcterms:created xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:created>
    <dcterms:modified xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:modified>
</cp:coreProperties>`);

                // docProps/app.xml
                zip.folder('docProps').file('app.xml',
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties" xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">
    <Application>æ–‡æ¡£æå–å™¨</Application>
    <DocSecurity>0</DocSecurity>
    <ScaleCrop>false</ScaleCrop>
    <Company></Company>
    <LinksUpToDate>false</LinksUpToDate>
    <SharedDoc>false</SharedDoc>
    <HyperlinksChanged>false</HyperlinksChanged>
    <AppVersion>1.0</AppVersion>
</Properties>`);

                // word/document.xml
                zip.folder('word').file('document.xml',
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" 
            xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
    <w:body>
        ${documentXml}
        <w:sectPr>
            <w:pgSz w:w="11906" w:h="16838"/>
            <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440" w:header="720" w:footer="720" w:gutter="0"/>
        </w:sectPr>
    </w:body>
</w:document>`);

                // word/_rels/document.xml.rels
                zip.folder('word').folder('_rels').file('document.xml.rels',
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
</Relationships>`);

                // ç”Ÿæˆdocxæ–‡ä»¶ï¼ˆè®¾ç½®æ­£ç¡®çš„MIMEç±»å‹ï¼‰
                const blob = await zip.generateAsync({
                    type: 'blob',
                    mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    compression: 'DEFLATE'
                });
                
                // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨Safari
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (isSafari && isMobile) {
                    // iOS Safariä½¿ç”¨ç‰¹æ®Šå¤„ç†
                    try {
                        // åˆ›å»ºæ­£ç¡®ç±»å‹çš„Blob
                        const correctBlob = new Blob([blob], {
                            type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                        });
                        
                        const url = URL.createObjectURL(correctBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `${originalFileName}_çº¯æ–‡å­—.docx`;
                        link.style.display = 'none';
                        
                        document.body.appendChild(link);
                        link.click();
                        
                        // å»¶è¿Ÿæ¸…ç†
                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }, 100);
                    } catch (err) {
                        console.error('Safari download error:', err);
                        saveAs(blob, `${originalFileName}_çº¯æ–‡å­—.docx`);
                    }
                } else {
                    // å…¶ä»–æµè§ˆå™¨ä½¿ç”¨FileSaver
                    saveAs(blob, `${originalFileName}_çº¯æ–‡å­—.docx`);
                }

                showStatus('âœ… Wordæ–‡æ¡£å·²ä¸‹è½½ï¼', 'success');
                downloadDocBtn.disabled = false;
                downloadDocBtn.innerHTML = '<span>ğŸ“˜</span><span>é‡æ–°ä¸‹è½½</span>';

            } catch (error) {
                console.error('ä¸‹è½½é”™è¯¯:', error);
                showStatus('ç”ŸæˆWordæ–‡æ¡£å¤±è´¥: ' + error.message, 'error');
                downloadDocBtn.disabled = false;
                downloadDocBtn.innerHTML = '<span>ğŸ“˜</span><span>ä¸‹è½½Wordæ–‡æ¡£</span>';
            }
        });

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // XMLè½¬ä¹‰å‡½æ•°
        function escapeXml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type) {
            statusText.textContent = message;
            status.className = 'status show ' + type;
        }
    </script>
</body>
</html>
